
<div class="taskparent">
    <p>To Do List</p>

    <ul class="tab">
        <li><a href="javascript:void(0)" class="tablinks" onclick="openCity(event, 'ShowTaskPage')">Tasks</a></li>
        <li><a href="javascript:void(0)" class="tablinks" onclick="openCity(event, 'Paris')">Paris</a></li>
        <li><a href="javascript:void(0)" class="tablinks" onclick="openCity(event, 'SharedTaskPage')">Shared Tasks</a></li>
    </ul>


    <div class="tabcontent" id="ShowTaskPage" style="display: block;" ng-app="myApp" ng-controller="myCtrl">
        <p id="demo"></p>
        <!-- LOOP OVER THE TODOS IN $scope.todos -->
        <table style="width:50%" id="myTbl_todo_2">
            <div data-role="popup" id="modify_todo_popup" class="ui-content" style="min-width:250px;">
                <form method="post" action="ModifyTask.js">
                    Start time of task <div><input type="time" id="STime_modify_" name="STime" ></div><br>
                    Start date of task <div><input type="date" id="SDate_modify_" name="SDate" ></div><br>
                    Finish time of task <div><input type="time" id="FTime_modify_" name="FTime" ></div><br>
                    Finish date of task <div><input type="date" id="FDate_modify_" name="FDate" ></div><br>
                    <script>
                        var today = new Date();
                        var dd = today.getDate();
                        var mm = today.getMonth()+1; //January is 0!
                        var yyyy = today.getFullYear();
                        if(dd<10){
                            dd='0'+dd
                        }
                        if(mm<10){
                            mm='0'+mm
                        }

                        today = yyyy+'-'+mm+'-'+dd;
                        document.getElementById("SDate").setAttribute("min", today);
                        document.getElementById("FDate").setAttribute("min", today);
                    </script>
                    <br>
                    Name of task <div><input type="text" id="NameTask_modify_" name="NameTask"></div><br>
                    Priority<br>
                    <span style="margin-left:2em">
                                    <input type="radio" id="priority_1_task_modify_" name="priority_task_modify_" value="1"> Urgent</span><br>
                    <span style="margin-left:2em">
                                    <input type="radio" id="priority_2_task_modify_" name="priority_task_modify_" value="2"> Pressing </span><br>
                    <span style="margin-left:2em">
                                    <input type="radio" id="priority_3_task_modify_" name="priority_task_modify_" value="3"> Normal </span><br>
                    <span style="margin-left:2em">
                                    <input type="radio" id="priority_4_task_modify_" name="priority_task_modify_" value="4"> Moderate </span><br>
                    Note <br>
                    <div><textarea id="NoteTask_modify_" name="NoteTask_modify_" rows=4 cols=50></textarea></div><br>
                    <br>
                    <button type="button" class="modify" id="modify_">Modify task</button>
                </form>
            </div>
            <div data-role="popup" id="done_todo_popup" class="ui-content" style="min-width:250px;">
                <form method="post" action="DoneTask.js">
                    Experience <br>
                    <div><textarea id="ExpTask" name="ExpTask" rows=4 cols=50></textarea></div><br>
                    <br>
                    <input type="checkbox" id="IsShareTask" name="IsShareTask" value="public">Do you want to share this task?<br>
                    <br>
                    <button type="button" class="done" id="done_btn_">Done task</button>
                </form>
            </div>
            <%include myTaskData.ejs %>
            <%

                var myData = getMyDatas();
                var myData2 = myData.myData2;
                var user = myData.user;

            for (i=0;i<myData2.length;i++){%>
            <%if(myData2[i].Status == 'Not'){%>
            <tr id="Row_<%= myData2[i].TaskId %>">
                <td align="left" style="cursor:pointer" name="NameTask2_<%= myData2[i].TaskId %>" id="NameTask2_<%= myData2[i].TaskId %>">
                    <%= myData2[i].NameTask %>
                 </td>
                <td align="left" name="delete_td_<%= myData2[i].TaskId %>">
                    <button type="button" id="delete_<%= myData2[i].TaskId %>">Delete</button>
                </td>
                <td align="left" name="modify_td_<%= myData2[i].TaskId %>">
                    <div data-role="main" class="ui-content">
                        <a href="#modify_todo_popup" data-rel="popup" class="ui-btn ui-btn-inline ui-corner-all">Modify</a>


                    </div>
                </td>
                <td align="left" name="done_td_<%= myData2[i].TaskId %>">
                    <button type="button" class="done" id="done_<%= myData2[i].TaskId %>" onclick="myDone(this.id)">Done</button>
                </td>
            </tr>
            <%}%>
            <%}%>
        </table>
        <script>
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var table = document.getElementById("myTbl_todo_2");
                    response_my_todo = JSON.parse(this.responseText);
                    for(var i in response_my_todo.myData2) {
                        if(response_my_todo.myData2[i].Status == 'NotYet') {
                            try {
                                var row = table.insertRow(0);
                                row.setAttribute("name", "Row_" + response_my_todo.myData2[i].TaskId);
                                // Task Infor field
                                var NameCell = row.insertCell(0);
                                NameCell.innerHTML = response_my_todo.myData2[i].NameTask;
                                NameCell.setAttribute("name", "NameTask2_" + response_my_todo.myData2[i].TaskId);
                                NameCell.setAttribute("id", "NameTask2_" + response_my_todo.myData2[i].TaskId);
                                NameCell.setAttribute("style", "cursor:pointer");
                                // Delete field
                                var DeleteCell = row.insertCell(1);
                                var DeleteBtn = document.createElement("BUTTON");
                                DeleteBtn.innerHTML = "Delete";
                                DeleteBtn.setAttribute("class", "ui-btn ui-btn-inline ui-corner-all");
                                DeleteCell.setAttribute("name", "delete_td_" + response_my_todo.myData2[i].TaskId);
                                DeleteBtn.setAttribute("id", "delete_" + response_my_todo.myData2[i].TaskId);
                                DeleteBtn.setAttribute("type", "button");
                                DeleteCell.appendChild(DeleteBtn);
                                // Modify field
                                var ModifyCell = row.insertCell(2);
                                ModifyCell.setAttribute("name", "modify_td_" + response_my_todo.myData2[i].TaskId);

                                var MainDiv = document.createElement("DIV");
                                ModifyCell.appendChild(MainDiv);
                                MainDiv.setAttribute("data-role", "main");
                                MainDiv.setAttribute("class", "ui-content");

                                var ModifyButton = document.createElement("A");
                                MainDiv.appendChild(ModifyButton);
                                ModifyButton.innerHTML = "Modify";
                                ModifyButton.setAttribute("href", "#modify_todo_popup");
                                ModifyButton.setAttribute("onclick", "setPara2Popup(" + i + ")");
                                ModifyButton.setAttribute("data-rel", "popup");
                                ModifyButton.setAttribute("class", "ui-btn ui-btn-inline ui-corner-all");
                                ModifyButton.setAttribute("id", "modify_button_" + response_my_todo.myData2[i].TaskId);
                                // Done field
                                var DoneCell = row.insertCell(3);
                                DoneCell.setAttribute("name", "done_td_" + response_my_todo.myData2[i].TaskId);

                                var MainDoneDiv = document.createElement("DIV");
                                DoneCell.appendChild(MainDoneDiv);
                                MainDoneDiv.setAttribute("data-role", "main");
                                MainDoneDiv.setAttribute("class", "ui-content");

                                var DoneButton = document.createElement("A");
                                MainDoneDiv.appendChild(DoneButton);
                                DoneButton.setAttribute("href", "#done_todo_popup");
                                DoneButton.setAttribute("onclick", "setPara2Popup4DoneButton(" + i + ")");
                                DoneButton.innerHTML = "Done";
                                DoneButton.setAttribute("data-rel", "popup");
                                DoneButton.setAttribute("class", "ui-btn ui-btn-inline ui-corner-all");
                            }
                            catch(ex){
                                alert(ex);
                            }
                        }
                    }
                    setFunction();
                }
            };
            xhttp.open("GET", "getTaskData", true);

            xhttp.send();
        </script>
    </div>

    <div class="tabcontent" id="Paris">
    </div>
    <div class="tabcontent" id="SharedTaskPage">
        <div class="classsharedtasks">
            <!-- LOOP OVER THE TODOS IN $scope.todos -->
            <table style="width:50%" id="myTbl">
                <%for (i=0;i<myData.length;i++){%>
                <tr>
                        <td align="left" name="NameTask_td_<%= myData[i].TaskId %>">
                        <label style="cursor:pointer" id="NameTask_<%= myData[i].TaskId %>">
                            <%= myData[i].NameTask %>
                        </label></td>
                        <td align="left"><span class="star-rating">
                              <a name="one_star" value="1" href="javascript: submitRating(<%= myData[i].TaskId %>,1, <%= user %>)"><img src="http://images.clipartpanda.com/clipart-star-RTA9RqzTL.png" alt="Smiley face" height="10" width="10"></a>
                              <a class="two_star" href="javascript: submitRating(<%= myData[i].TaskId %>,2, <%= user %>)"><img src="http://images.clipartpanda.com/clipart-star-RTA9RqzTL.png" alt="Smiley face"   height="10"   width="10"></a>
                              <a class="three_star" href="javascript: submitRating(<%= myData[i].TaskId %>,3, <%= user %>)"><img src="http://images.clipartpanda.com/clipart-star-RTA9RqzTL.png" alt="Smiley face" height="10"   width="10"></a>
                              <a class="four_star" href="javascript: submitRating(<%= myData[i].TaskId %>,4, <%= user %>)"><img src="http://images.clipartpanda.com/clipart-star-RTA9RqzTL.png" alt="Smiley face"  height="10" width="10"></a>
                              <a class="fives_star" href="javascript: submitRating(<%= myData[i].TaskId %>,5, <%= user %>)"><img src="http://images.clipartpanda.com/clipart-star-RTA9RqzTL.png" alt="Smiley face" height="10"   width="10"></a>
                            </span></td>
                </tr>
                <tr>
                    <td></br><b>Comments</b></td>
                </tr>
                <tr>
                    <td>
                        <table id="show_comment_<%= myData[i].TaskId %>">
                            <% for(j=0;j < myComments.length; j++){
                            for(k=0;k<myComments[j].length;k++){%><td><tr>
                                    <%if(myComments[j][k].TaskId == myData[i].TaskId){
                                    %>
                                    <%= myComments[j][k].Comment %></br>
                                    <%}%></tr></td><%}}%>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td align="left" colspan="2" id="comment_td_<%= myData[i].TaskId %>" name="comment_td_<%= myData[i].TaskId %>">
                        <input type="text" id="comment_<%= myData[i].TaskId %>" width="200px"/>
                    </td>
                </tr>
                <%}%>
            </table>
        </div>
    </div>
</div>

<script>
    function setFunctionForSharedField(){
        var table = document.getElementById("myTbl");
        var tds = table.getElementsByTagName("td");
        var matchingTds = [];
        var myNameTasks = [];

        for (var i = 0, len = tds.length, td, tdName; i < len; ++i) {
            td = tds[i];
            tdName = td.getAttribute("name");
            if (tdName && tdName.indexOf("NameTask_td_") == 0) {
                myNameTasks.push(td.getElementsByTagName("label")[0]);
            }
            else if (tdName && tdName.indexOf("comment_td_") == 0) {
                matchingTds.push(td.getElementsByTagName("input")[0]);
            }
        }
        for (var j = 0; j < matchingTds.length; j++) {
            var myStr = "#" + matchingTds[j].id;
            $(myStr).keydown(function (e) {
                if (e.which == 13) {
                    submitComment($(this).attr('id'), $(this).val(), <%= user %>);
                    $(this).val("");
                }
            });
        }
        for (var k = 0; k < myNameTasks.length; k++) {
            var myStr = "#" + myNameTasks[k].id;
            $(myStr).click(function () {
                submitSuggestion($(this).attr('id'), $(this).text().trim());
            });
        }
    }

    function setFunction(){
        try {
            var table2 = document.getElementById("myTbl_todo_2");
            var tds2 = table2.getElementsByTagName("td");
            var DeleteBtns = [];
            var myNameTasks2 = [];
            for (var i2 = 0, len2 = tds2.length, td2, tdName2; i2 < len2; ++i2) {
                td2 = tds2[i2];
                tdName2 = td2.getAttribute("name");
                if (tdName2 && tdName2.indexOf("NameTask2_") == 0) {
                    myNameTasks2.push(td2);
                }
                else if (tdName2 && tdName2.indexOf("delete_td_") == 0) {
                    DeleteBtns.push(td2.getElementsByTagName("button")[0]);
                }
            }
            for (var j2 = 0; j2 < DeleteBtns.length; j2++) {
                var myStr2 = "#" + DeleteBtns[j2].id;
                $(myStr2).click(function () {
                    myDelete($(this).attr('id'));
                });
            }
            for (var k2 = 0; k2 < myNameTasks2.length; k2++) {
                var myStr2 = "#" + myNameTasks2[k2].id;
                $(myStr2).click(function () {
                    submitSuggestion($(this).attr('id'), $(this).text().trim());
                });
            }
        }catch(ex){
            alert(ex);
        }
    }

    function setPara2Popup(ParaSet){
        try {
            var STime_modify_ = document.getElementById("STime_modify_");
            STime_modify_.setAttribute("value", response_my_todo.myData2[ParaSet].startTime);

            var SDate_modify_ = document.getElementById("SDate_modify_");
            SDate_modify_.setAttribute("value", response_my_todo.myData2[ParaSet].startDate);

            var FTime_modify_ = document.getElementById("FTime_modify_");
            FTime_modify_.setAttribute("value", response_my_todo.myData2[ParaSet].finishTime);

            var FDate_modify_ = document.getElementById("FDate_modify_");
            FDate_modify_.setAttribute("value", response_my_todo.myData2[ParaSet].finishDate);

            var NameTask_modify_ = document.getElementById("NameTask_modify_");
            NameTask_modify_.setAttribute("value", response_my_todo.myData2[ParaSet].NameTask);

            var NoteTask_modify_ = document.getElementById("NoteTask_modify_");
            NoteTask_modify_.value = response_my_todo.myData2[ParaSet].NoteTask;

            var SubmitModify = document.getElementById("modify_");
            SubmitModify.setAttribute("onclick", "myModify(" + response_my_todo.myData2[ParaSet].TaskId + ")");

            var priority_1_task_modify_ = document.getElementById("priority_1_task_modify_");
            if (response_my_todo.myData2[ParaSet].priorityTask == 1)
                priority_1_task_modify_.checked = true;
            var priority_2_task_modify_ = document.getElementById("priority_2_task_modify_");
            if (response_my_todo.myData2[ParaSet].priorityTask == 2)
                priority_2_task_modify_.checked = true;
            var priority_3_task_modify_ = document.getElementById("priority_3_task_modify_");
            if (response_my_todo.myData2[ParaSet].priorityTask == 3)
                priority_3_task_modify_.checked = true;
            var priority_4_task_modify_ = document.getElementById("priority_4_task_modify_");
            if (response_my_todo.myData2[ParaSet].priorityTask == 4)
                priority_4_task_modify_.checked = true;
        }catch(ex){
            alert(ex);
        }
    }

    function setPara2Popup4DoneButton(ParaSet){
        try {
            var SubmitDone = document.getElementById("done_btn_");
            SubmitDone.setAttribute("onclick", "myDone(" + response_my_todo.myData2[ParaSet].TaskId + ")");
        }catch(ex){
            alert(ex);
        }
    }
</script>
<script>
    function myDelete(id){
        id = id.split('_');
        id = id[id.length - 1];
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var row = document.getElementById("Row_" + id);
                row.parentNode.removeChild(row);
            }
        };
        xhttp.open("POST", "ShowTask?id=" + id, true);

        xhttp.send();
    }

    function myModify(id) {
        var myId = id;
        var STime = $("#STime_modify_").val();
        var SDate = $("#SDate_modify_").val();
        var FTime = $("#FTime_modify_").val();
        var FDate = $("#FDate_modify_").val();
        var NameTask = $("#NameTask_modify_").val();
        var NoteTask = $("#NoteTask_modify_").val();
        var priority = 4;
        if(document.getElementById("priority_1_task_modify_").checked)
            priority = 1;
        else if(document.getElementById("priority_2_task_modify_").checked)
            priority = 2;
        if(document.getElementById("priority_3_task_modify_").checked)
            priority = 3;

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                // TODO modify task and close popup
                try {
                    $("#NameTask2_" + myId).val(NameTask);
                    //$("#modify_todo_popup").popup("close");
                }
                catch(ex){
                    alert(ex);
                }
            }
        };
        xhttp.open("POST", "ModifyTask", true);
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhttp.send("id="+myId+"&STime="+STime+"&SDate="+SDate+"&FTime="+FTime+"&FDate="+FDate+"&NameTask="+NameTask+"&NoteTask="+NoteTask+"&priority="+priority);
    }

    function myDone(id) {
        var myId = id;
        var exp = $("#ExpTask").val();
        var shared = document.getElementById("IsShareTask").checked;

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                // TODO done task and close popup
                try {
                }
                catch(ex){
                    alert(ex);
                }
            }
        };
        xhttp.open("POST", "DoneTask", true);
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhttp.send("id="+myId+"&exp="+exp+"&shared="+shared);
    }

    function submitRating(id, star, user) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                // TO DO: insert image of star

            }
        };
        xhttp.open("POST", "SharedTasks?id=" + id + "&star=" + star + "&user=" + user, true);
        xhttp.send();
    }

    function submitComment(id, cmmt, user){
        id = id.split('_');
        id = id[id.length - 1];
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                // alert("OK");
                // document.getElementById("demo").innerHTML = cmmt;
                var tableCmmt = document.getElementById("show_comment_" + id);
                var rowCmmt = tableCmmt.insertRow(-1);
                var cellCmmt = rowCmmt.insertCell(0);
                cellCmmt.innerHTML = cmmt;
            }
        };
        xhttp.open("POST", "CommentTask?id=" + id + "&cmmt=" + cmmt + "&user=" + user, true);

        xhttp.send();
    }

    function submitSuggestion(id, sug){
        id = id.split('_');
        id = id[id.length - 1];
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                // alert("OK");
                // document.getElementById("demo").innerHTML = cmmt;
            }
        };
        xhttp.open("POST", "SuggestTask?id=" + id + "&sug=" + sug, true);

        xhttp.send();
    }
</script>

<script>
    function openCity(evt, cityName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(cityName).style.display = "block";


        evt.currentTarget.className += " active";
    }
</script>

